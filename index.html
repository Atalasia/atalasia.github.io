<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/index.css">
</head>
<body>
<div class="container">
  <div class="map">
    <div id="vis"></div>
  </div>
  <div id="textbox">
    <div id="locationInfo"></div>
  </div>
</div>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script>

  var ele = document.getElementById("vis"); // Do not use #
  var eleStyle = window.getComputedStyle(ele);
  
  var colWidth = parseFloat(eleStyle.width);
  var mapHeight = window.screen.availHeight;

  var margin = {top: 0, right: 0, bottom: 0, left: 0},
    width = colWidth - margin.left - margin.right,
    height = mapHeight - margin.top - margin.bottom;

  var hexagon_diameter = 30;
  var diagram_length = 55;

  if(colWidth <= 768){
    hexagon_diameter = 20;
    //height = mapHeight;
  }

  var cv = d3.select("#vis")
    .append("canvas").attr("id","canvas")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom);

  var context = cv.node().getContext("2d");
  paintHexMap(hexagon_diameter, diagram_length, width/2, height/2, context);

  var svg = d3.select("#vis")
    .append("svg")
    .attr('class', 'overlay')
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .call(d3.zoom()
        .scaleExtent([1/2, 4])
        .on('zoom', syncedZoom))
    .append("g");


  let textbox = d3.select("#textbox").style("opacity","0");
  let infotext = d3.select("#locationInfo").style("opacity","0");

  //d3.json("data/events.json", function(events){
   
var events = [
  {"a":21,"b":-10,"c":-11,"title":"Yellow City","description":"Entrance to the Yellow City. Embedded with unkept ancient ruins. Party saw a raving woman that screams \"Unclean Meat\"(which Ugg mugged for ruby bracelet), a little girl obsessed with finding gold and faced a traffic jam caused by slavers randomly picking up people as slaves. Frosty initiated the fight and party managed to defeat the slavers.","npcs":"","tiletype":"city"},
  {"a":21,"b":-9,"c":-12,"title":"Yellow City","description":"Entrance to the Yellow City. Embedded with unkept ancient ruins. Party saw a raving woman that screams \"Unclean Meat\"(which Ugg mugged for ruby bracelet), a little girl obsessed with finding gold and faced a traffic jam caused by slavers randomly picking up people as slaves. Frosty initiated the fight and party managed to defeat the slavers.","npcs":"","tiletype":"city"},
  {"a":20,"b":-9,"c":-11,"title":"Yellow City","description":"Entrance to the Yellow City. Embedded with unkept ancient ruins. Party saw a raving woman that screams \"Unclean Meat\"(which Ugg mugged for ruby bracelet), a little girl obsessed with finding gold and faced a traffic jam caused by slavers randomly picking up people as slaves. Frosty initiated the fight and party managed to defeat the slavers.","npcs":"","tiletype":"city"},
    {"a":12,"b": -5,"c":7,"title":"Goblin Attack","description":"The party faced a goblin party, which the party promptly wiped the floor with.","npcs":"", "tiletype":"route"},
    {"a":1, "b": -1, "c":0,"title":"Dead Wife River","description":"On the route to Yellow City, party encountered a naked man carrying a drowned womanâ€™s body, a broken raft carrying a man and four children, some screaming priests, and a half drowned woman on the river bank. They save the children, one of whom recites a bizarre nursery rhyme, and continue on their way.","npcs":"", "tiletype":"route"},
    {"a":-9, "b":7, "c":2, "title":"Agoha", "description":"The town that the caravan visited before entering Yasha's Estate.","npcs":"", "tiletype":"town"},
    {"a":-4, "b":2, "c":2, "title":"The Tower of Stargazer", "description":"Desolate observatory-tower surrounded by lightning from magical disturbance. The tower is fairly small. A mad and powerful wizard by the name of Calsidius resides in it to study different planets in different planes. The said wizard is currently locked up in a magic circle by his head servant. <br><br> B2 - there are treasure boxes bounded by Wall of Force and the Prismatic Wall. <br> B1 - A lab in which Calsidius used to perform necromantic studies. <br> 1 - Waiting room, guest room, entrance. <br> 2 - Servant's quarters, kitchen <br> 3 - The wizard's study. The magic circle in which the wizard is locked in is here.<br> 4 - Library floor. There is a refrigerator too. Ghost guards the path to library with more valueable books. <br> 5 - Observatory of astral planets. Bo, the bard, tragically died by activiating a telescope perfectly well and as a result being thrown into a planet in some other plane resulting in pink goo. He became the food of dancing mushrooms aliens.", "npcs":"Uravillon Calsidius - The mad wizard, senile and mad from 59 years of isolation. He is one of the most powerful spellcasters in the world. <br>Argyle Timmons - Head servant, magic apprentice of Uravillon. Betrayed the wizard and trapped in a 9th level magic circle. Currently left the tower with Uravillon's spell book.", "tiletype":"poi"},
    {"a":-4, "b":4, "c":0, "title":"The Yasha Estate", "description":"Peaceful and wealthy farming plantation estate. Extremely well kept and maintained. Grows lavender and wheat. Has 2 giant fireflies for farming.","npcs":"Daisy - Passerby. Invited Teg to the Wild Rose Tea Shop.<br>Grenzel - Estate Guard<br>Yasha - Plantation Owner<br>Ravi - Firefly handler<br>Gondrick - Estate Guard Captain<br>The Daughter - Has been 10 year old for 50 years. Will be turning 13 upcoming month.", "tiletype":"town"},
    {"a":-3, "b":4, "c":-1, "title":"Gurgari", "description":"A typical city in a 100 Kingdoms area. Well off and currently rising in power. Has a operation base of a pretty big smuggling ring called the Alliance and a cadre of high nobles titled Zamundar. The city is famous for jewelry, and crops. Six-story buildings, marble sculptures, nobles with face embedded with jewelry show that the kingdom is luxurious and vain. Although adorned in riches, the city is starting to show rot and tear in its society, but for a rising kingdom it seems off.<br><br>Temple of the Moth God - The temple of a god served by the people here. Well lit and well guarded.<br><br>", "npcs":"Sau Saj - Pigman Bard. Proficient in small hand percussion and mandolin.<br>Faizal - Ruler of the kingdom and a Zamundar. Obsessed with self adornment and beauty bordering on madness.<br>Fae - Faizal's daughter. A devout follower in the Cult of the Elephant Demon. ", "tiletype":"town"},
    {"a":-2, "b":3, "c":-1, "title":"Path to the Swamp", "description":"On crossing a bridge over a dry gorge, the party faced a lizardfolk shaman who brought a number of skeletons. The lizardfolk was slain and properly cremated/salted.<br>There is a cave where rangers of Gurgari frequent. The party was attacked by rats while resting.","npcs":"", "tiletype":"route"},
    {"a":-1, "b":3, "c":-2, "title":"The Swamp", "description":"The swamp where the aligator spirit which made a pact with Yasha lives. Was in a deadlock between different entities over the control of the swamp.", "npcs":"The Ancient Serpent - Ancient snake creature<br>Agatha - Night Hag, leader of a coven of green hags. 2 Green hags were slain. She was taking part in controlling the dead gator god. Burned to crisp by Teg.<br>The Great Gator God - Wears medieval military formal attire, white khakis. Controls catfish. Has a penchant for using presidigitation as parlor tricks. Turns out, the gator god was long dead was impersonated by a hag and a catfish spirit.<br>Amos - Mercenary fighter. Limbs were amputated and was slain by the party.<br>Hirugar - Former Ranger. Met with a deity of a forest, became a new man.<br>Catfish Fiend - Took part in impersonation of the Gator God. Summons lightnings and gator things (undead or not) from varios places. Slain brutally by Marcus.", "tiletype":"poi"} 
 ]

    var eventHexes = addEventDoms(hexagon_diameter, width/2, height/2, events);
    var eventgrid = svg
      .selectAll("g.grid")
      .data(eventHexes)
      .enter()
      .append("g")
      .attr("transform", function(hex) {
        return "translate(" + hex.x + "," + hex.y + ")";
      });

    var infoOn = false;

    eventgrid
      .append("polygon")
      .attr("points", function(hex) { 
        return hex.points.map(function(d){ 
          return [d.x,d.y].join(",");}).join(" ");
      })
      .attr("stroke", function(d){return getTileColorStroke(d);})
      .attr("stroke-width", "2")
      .attr("fill", function(d){return getTileColorFill(d);})
      .on("click", function(d) {

          if(infoOn == true){
              eventgrid.selectAll("polygon").attr("stroke", function(dd){ return getTileColorStroke(d);});
              textbox.style("opacity", 0);
              textbox.style("height", 0);
              infotext.style("opacity", 0);
              infotext.style("max-height",0);
              infoOn = false;
          } else {
              eventgrid.selectAll("polygon").attr("stroke", function(dd){ return getTileColorStroke(d);});
              d3.select(this).attr("stroke", function(dd){ return "#ffffff" });
              textbox.style("opacity", 0.9);
              textbox.style("height","50%");
              infotext.style("opacity", 0.9);
              infotext.style("max-height","100%");
              infotext.html(infoBoxTextGen(d));
              infoOn = true;
          }

      });
  //});
  
  function syncedZoom(){
    //zoom & pan SVG 
    svg.attr("transform", d3.event.transform)
    //zoom & pan Canvas -- copied from Mike Bostock's code (https://bl.ocks.org/mbostock/3680958)
    var transform = d3.event.transform;
    context.save();
    context.clearRect(0, 0, colWidth, mapHeight);
    context.translate(transform.x, transform.y);
    context.scale(transform.k, transform.k);
    paintHexMap(hexagon_diameter, diagram_length, width/2, height/2, context);
    context.restore();
  }

  function infoBoxTextGen(d){

    
    let index = "(" + d.a + "," + d.b + "," + d.c + ")";
    let title = "<b>" + d.title + "</b>";

    return index + "<br><br>" + title + "<br>" + d.description + "<br><br>" + d.npcs;
  }

  function addEventDoms(hexRadius, centerX, centerY, events){

    const sqrt3 = Math.sqrt(3);

    let r = hexRadius;
    var hexes = [];

    for(i in events){

      let event_a = events[i].a;
      let event_b = events[i].b;
      let event_c = events[i].c;

      let hexCenterX = centerX + (3/2 * r) * event_a;
      let hexCenterY = centerY + (sqrt3/2 * r) * event_a + (sqrt3 * r) * event_b;

      let hex = makeHexDom(r, hexCenterX, hexCenterY, event_a, event_b, event_c); //adds geometry and placement related stuff only
      
      //detailed explanations are added from here.
      hex.title = events[i].title;
      hex.description = events[i].description;
      hex.type = events[i].type;
      hex.npcs = events[i].npcs;
      hex.tt = events[i].tiletype;

      hexes.push(hex);
    }

    return hexes;
  }

  function paintHexMap(hexRadius, mapRadius, centerX, centerY, ctx){

    const sqrt3 = Math.sqrt(3);

    let r = hexRadius;

    let i, j;
    for(i = -mapRadius; i <= mapRadius; i++){ //x 
      for(j = -mapRadius; j <= mapRadius; j ++){ //y

        let a = i; 
        let b = j; 
        let c = 0 - i - j;      

        if(c > mapRadius || c < -mapRadius ){
          continue;
        }

        let hcx = centerX + (3/2 * r) * i;
        let hcy = centerY + (sqrt3/2 * r) * i + (sqrt3 * r) * j;

        ctx.beginPath();
        ctx.moveTo(r/2 + hcx, (sqrt3/2 * r) + hcy);
        ctx.lineTo(r + hcx, hcy);
        ctx.lineTo(r/2 + hcx, (-sqrt3/2 * r) + hcy);
        ctx.lineTo((-r/2) + hcx, (-sqrt3/2 * r) + hcy);
        ctx.lineTo((-r) + hcx, hcy);
        ctx.lineTo((-r/2) + hcx, (sqrt3/2 * r) + hcy);
        ctx.lineTo(r/2 + hcx, (sqrt3/2 * r) + hcy);
        ctx.strokeStyle = '#D3D3D3';
        ctx.stroke();
  
      }
    }
  }

  function makeHexDom(r, x, y, a, b, c){

    const sqrt3 = Math.sqrt(3);

    let hex = [];
    let vertices = [];

    //flat top, clockworkwise 
    vertices.push({x: r/2, y: sqrt3/2 * r });
    vertices.push({x: r, y: 0 });
    vertices.push({x: r/2, y: -sqrt3/2 * r });
    vertices.push({x: -r/2, y: -sqrt3/2 * r });
    vertices.push({x: -r, y: 0 });
    vertices.push({x: -r/2, y: sqrt3/2 * r });

    hex.x = x; //center position
    hex.y = y; //center position

    hex.a = a; //index
    hex.b = b; //index
    hex.c = c; //index

    hex.points = vertices;

    return hex;
  }

  function getTileColorStroke(d){

    switch(d.tt){
      default:
        return "#0e1111"
    }
  }

  function getTileColorFill(d){
    switch(d.tt){
      case "town":
        return "#0093D1";
      case "route":
        return "#eeeeee";
      case "city":
        return "#006495";
      case "poi":
        return "#e62739";
      default:
        return "#000000"
    }
  }
</script>
</body>
</html>
